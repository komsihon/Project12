{% extends 'core/app_base_admin.html' %}
{% load i18n humanize static auth_tokens %}

{% block page_title %}
<title> {% if obj.member.is_ghost %}{{ obj.member.email }}{% else %}{{ obj.member.full_name }}{% endif %} - {{ service.project_name }} </title>
{% endblock %}

{% block head_style %}
    {{ block.super }}
    <link rel='stylesheet' href="{% static 'ikwen/css/change-form.css' %}" />
    <link rel='stylesheet' href="{% static 'daraja/css/daraja-admin.css' %}?v=20.03.16" />
    <link rel='stylesheet' href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
{% endblock %}

{% block breadcrumb_location %}
    <li>
        <a href="{% url 'billing:subscription_list' %}">{% trans "Subscriptions" %}</a>
    </li>
    <li>{% if obj.member.is_ghost %}{{ obj.member.email }}{% else %}{{ obj.member.full_name }}{% endif %}</li>
{% endblock %}

{% block admin_content %}
    <div id="admin-content">
        <div class="container-fluid">
            <div id="stage" class="row" style="float: none">
                {% if obj %}
                {% with dara=obj %}
                    {% url 'ikwen:profile' member.id as member_profile_url %}
                    <div>
                        <div class="pull-left">
                            <span class="label level-{{ dara.level }}" style="font-size: 95%; padding: 0.5em">
                            {% if dara.level == 1 %}
                                {% trans "Running playground" %}
                            {% elif dara.level == 2 %}
                                {% trans "Live Challenge" %}
                            {% else %}
                                {% trans "Kako-master" %}
                            {% endif %}
                            ({% trans 'Level ' %}{{ dara.level }})
                            </span>
                        </div>
                        <div class="pull-right">
                           <span class="label xp-{{ dara.xp }}" style="font-size: 95%; padding: 0.5em">{% blocktrans with xp=dara.xp  %}Experience {{ xp }} {% endblocktrans %}</span>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                    <div>
                        <div class="text-center">
                            <div class="welcome-title">
                                {% if dara.member.photo.name %}
                                    <img class="img-circle img-thumbnail" src="{{ settings.IKWEN_MEDIA_URL }}{{ dara.member.photo.small_name }}" style="margin-top: 1vh;width:100px;height:100px">
                                {% else %}
                                    <img class="img-circle img-thumbnail" src="{% static 'ikwen/img/login-avatar.jpg' %}" style="margin-top: 1vh;">
                                {% endif %}
                                <h4>{{ dara.member.full_name }}</h4>
                                {% if dara.level == 1 %}
                                    <img class="img-responsive img-thumbnail" src="{% static 'daraja/img/bronze-badge1.jpg' %}" width="50" style="border: none">
                                {% elif dara.level == 2 %}
                                    <img class="img-responsive img-thumbnail" src="{% static 'daraja/img/silver-badge1.jpg' %}" width="50" style="border: none">
                                {% else %}
                                    <img class="img-responsive img-thumbnail" src="{% static 'daraja/img/gold-badge1.jpg' %}" width="50" style="border: none">
                                {% endif %}
                            </div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                {% endwith %}
                {% endif %}
                <form class="col-sm-8 col-sm-offset-2" method="post">{% csrf_token %}
                    {% if form.errors %}
                        <div class="errorlist">{{ form.errors }}</div>
                    {% endif %}
                    <div class="subscription-details{% if not obj and not form.errors %} tpl{% endif %}">
                        {% include 'core/snippets/model_admin_form.html' %}
                        <div style="padding-top: 30px; margin-bottom: 10px">
                            <div class="col-xs-12 col-sm-8 col-md-4">
                                <button class="btn btn-sm btn-block btn-success">{% trans "Save" %}</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    {{ block.super }}
    <script type="text/javascript">
        (function() {
            $('div#admin-nav .profile').addClass('active');
            $('.form-row').addClass('form-group');
            $('.form-row input, .form-row select, .form-row textarea').addClass('form-control input-sm');
            $('.form-row textarea').addClass('form-control input-sm');

            $('.results.customers').on('click', 'li.member', function() {
                var customerId = $(this).data('id'),
                    customerName = $(this).find('.full_name').text();
                if (customerId && customerName) {
                    $('#customer-id').val(customerId);
                    $('#customer-name').val(customerName);
                    $('#stage .continue').prop('disabled', false);
                }
            }).css('width', $('#customer-name').css('width'));

            $('#stage').on('click', '.continue', function() {
                $(this).hide();
                $('.subscription-details').show();
            });
            $('#customer-name').keyup(function() {
                var val = $(this).val();
                if (val.isValidEmail()) {
                    $('#customer-id').val('');
                    $('#customer-email').val(val);
                    $('#stage .continue').prop('disabled', false);
                } else {
                    $('#customer-email').val('');
                    $('#stage .continue').prop('disabled', true);
                }
            });
            $('#id_expiry').removeAttr('name').datepicker({
                altField: "#expiry-alt",
                altFormat: "yy-mm-dd"
            });
            {% if not obj %}
            {% url 'ikwen:member_list' as list_members_url %}
            var searchDescriptor = [{
                endpoint: '{{ list_members_url }}',
                resultTplSelector: '.results.customers li.member',
                maxChars: function() {
                    // The max number of characters that will be taken into consideration
                    // in the string typed by user to do the search. Characters above that
                    // limit will be ignored.
                    return Math.max($('#customer-name').val().length, 4);
                }
            }];
            $('#customer-name').focusout(function() {$('.results.customers').fadeOut()});
            ikwen.setupSearch('#customer-name', '.results.customers', searchDescriptor);

            var productCosts = {{ product_costs|safe }};
            $('#id_product').change(function() {
                var product_id = $(this).val();
                $('#id_monthly_cost').val(productCosts[product_id]);
            });
            {% endif %}
        })()
    </script>
{% endblock %}
